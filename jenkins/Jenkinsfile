pipeline { 
    agent any 

    environment { 
        PROJECT_DIR = "/var/jenkins_home/workspace/movierec-cicd" 
        FRONTEND_IMAGE = "movierec-frontend:${BUILD_NUMBER}" 
        BACKEND_IMAGE = "movierec-backend:${BUILD_NUMBER}" 
        AI_IMAGE = "movierec-ai:${BUILD_NUMBER}" 
    } 

    stages { 
        stage('Préparation') { 
            steps { 
                ws("${PROJECT_DIR}") { 
                    echo "========== Début du Pipeline ==========" // Copier les fichiers depuis /vagrant vers le workspace Jenkins 
                    sh 'cp -r /vagrant/* .' 
                    sh ''' 
                        docker --version 
                        docker compose version 
                        ls -la $PROJECT_DIR 
                    ''' 
                } 
            } 
        } 

        stage('Vérification structure') { 
            steps { 
                ws("${PROJECT_DIR}") { 
                    sh ''' 
                        echo "=== Frontend ===" 
                        ls -la frontend 
                        echo "=== Backend ===" 
                        ls -la backend 
                        echo "=== AI Service ===" 
                        ls -la ai-service 
                    ''' 
                } 
            } 
        } 

        stage('Build Frontend') { 
            steps { 
                ws("${PROJECT_DIR}") { 
                    dir('frontend') { 
                        sh 'docker build -t $FRONTEND_IMAGE .' 
                    } 
                } 
            } 
        } 

        stage('Build Backend') { 
            steps { 
                ws("${PROJECT_DIR}") { 
                    dir('backend') { 
                        sh 'docker build -t $BACKEND_IMAGE .' 
                    } 
                } 
            } 
        } 

        stage('Build AI Service') { 
            steps { 
                ws("${PROJECT_DIR}") { 
                    dir('ai-service') { 
                        sh 'docker build -t $AI_IMAGE .' 
                    } 
                } 
            } 
        } 

        stage('Déploiement') { 
            steps { 
                ws("${PROJECT_DIR}") { 
                    sh 'docker compose down || true; docker compose up -d' 
                } 
            } 
        } 

        stage('Vérification Santé') { 
            steps { 
                ws("${PROJECT_DIR}") { 
                    sh ''' 
                        sleep 10 
                        curl -f http://localhost:3000 || exit 1 
                        curl -f http://localhost:5000/health || exit 1 
                        curl -f http://localhost:8000/health || exit 1 
                    ''' 
                } 
            } 
        } 
    } 

    post { 
        success { 
            echo "✅ Pipeline réussi" 
        } 
        failure { 
            echo "❌ Pipeline échoué" 
        } 
    } 
}